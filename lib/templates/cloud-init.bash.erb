#! /usr/bin/env bash

export ENV='<%= env %>'
export CLOUDNAME='<%= cloud %>'
export DEPLOY='<%= deploy %>'

AVAILABILITY_ZONE=$(curl http://169.254.169.254/latest/meta-data/placement/availability-zone)
export REGION="${AVAILABILITY_ZONE:0:${#AVAILABILITY_ZONE} - 1}"

export CHEF_ENVIRONMENT='${ENV}.${CLOUDNAME}'
export CHEF_VERSION='12.0'

if [[ -f /cloud-init-successful ]]
  then

  exit 0
fi

rm /cloud-init-failed 2&>1 /dev/null

apt-get install -y awscli
curl -LO https://www.chef.io/chef/install.sh && sudo bash ./install.sh -v $CHEF_VERSION && rm install.sh

mkdir -p /etc/chef
aws s3 --region $REGION cp s3://$ENV.$REGION.$CLOUDNAME.instance.cloudstrap.leafme/validator.pem /etc/chef/validation.pem


CHEF_SERVER_URL="https://api.opscode.com/organizations/leaf-$ENV"

rm /etc/chef/client.rb  2&>1 /dev/null
echo "chef_server_url           '$CHEF_SERVER_URL'"         >> /etc/chef/client.rb
echo "validation_client_name    'leaf-$ENV-validator'"      >> /etc/chef/client.rb
echo "validation_key            '/etc/chef/validation.pem'" >> /etc/chef/client.rb

chef-client # no args, to register the node

chef-client -r leaf-deploy-$DEPLOY

crontab -l | { cat; echo "*/5 * * * * chef-client -r leaf-deploy-$DEPLOY"; } | crontab -

CHEF_RETVAL=$?
if [[ $CHEF_RETVAL -eq 0 ]]
  then
  touch /cloud-init-successful
  exit 0
else
  echo $CHEF_RETVAL > /cloud-init-failed
  exit 1
fi